
<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="rocketchat-connection">
  <template>
    <style>

    </style>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'rocketchat-connection',

        properties: {
          url: {
            type: String,
          },
          username: {
            type: String,
          },
          password: {
            type: String,
          },
          room: {
            type: String,
          },
          messages: {
            type: Array,
            notify: true,

          }
        },

        addMessages: function (messages) {
          if (!Array.isArray(this.messages)) {
            console.log(messages)
            this.messages = messages;
            console.log(this.messages);
          } else {

            messages.forEach((message) => {
              this.push('messages', message);
            });
          }
        },

        connect: function () {
          return new Promise((resolve, reject) => {
            var connection = new ddp({
              endpoint: this.url+ 'websocket',
              SocketConstructor: WebSocket
            });

            connection.on('connected', () => {
              this.connection = connection;
              resolve();
            });

            connection.on('changed', function (message) {
              console.log(message);
            });

            connection.on('added', function (message) {
              console.log(message);
            });

            connection.on("ready", function (message) {
              console.log(message)
            })

            //connection.sub('settings');
            connection.sub('stream-notify-all');
            connection.sub('stream-notify-room');
            connection.sub('stream-notify-user');
            connection.sub('scopedRoles', 'Users');
            connection.sub('scopedRoles', 'Subscriptions');
            connection.sub('roles');
            //connection.sub('permissions');
            connection.sub('integrations');
            connection.sub('oauthApps');
            connection.sub('subscription');
            connection.sub('userData');
            //connection.sub('activeUsers');
            connection.sub('meteor_autoupdate_clientVersions');
            connection.sub('stream-messages', null);

            //connection.sub('room', 'cGENERAL');

          });
        },

        login: function () {
          return new Promise((resolve, reject) => {

            var id = this.connection.method('login', [{
              user: {
                email: this.username
              },
              password: this.password
            }]);

            this.connection.on('result', (message) => {
              if (message.id === id) {
                console.log('Login: ', message);
                resolve();
              }
            })
          });
        },

        loadHistory: function (roomId) {
          return new Promise((resolve, reject) => {

            var methodId = this.connection.method('loadHistory', [roomId, null, 100, new Date()]);

            this.connection.on('result', (message) => {
              if (message.id === methodId) {
                this.connection.sub('room', ['c'+roomId]);
                resolve(message.result.messages);
              }
            });

          });
        },

        ready: function() {
          this.connect().then(() => {

            this.login().then(() => {
              console.log('Successfully Logged In');
              this.loadHistory(this.room).then((messages) => {
                this.addMessages(messages);
              });

            }).catch((err) => console.log('Error Logging In', err));
          }).catch((err) => console.log('Error Connecting', err));
        }
      });
    })();
  </script>
</dom-module>
